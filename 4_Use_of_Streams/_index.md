---
title: "4. 流的使用"
anchor: "4_Use_of_Streams"
weight: 400
rank: "h1"
---

QUIC流的多路复用特性允许应用在单条连接之上运行多条流，而不会引入流与流之间的队头阻塞。
流数据是用帧来传递的，通信线路上的一个QUIC数据包能够携带一个或多个流帧。

流可以是单向的或双向的，且流可以由客户端和服务器中的任意一方发起。
对于单向流，只有其发起方才能发送数据。

由于流数据偏移字段的编码限制和连接上的流量控制限制，流和连接分别只能在单个方向上传递至多<code>2<sup>62</sup>-1</code>字节的数据。
在应用触及该上限这样一种不太可能发生的情况下，应该建立新连接。

流可以被，优雅地或强行地，独立打开和关闭。
应用可以通过令QUIC在**流帧**中发送`FIN`置位的方式，优雅地将某条流的发送方向关闭。
只要对端没有发送`FIN`，它就不能优雅地关闭流的接收方向，这和TCP很像。
然而，终端可以强行关闭发送方向，或要求对端强行关闭接收方向；这些操作完全不依赖于对端的意愿。

QUIC并不提供对任何流进行异常处理的接口。
如果一条对于应用来说很关键的流被关闭了，那么应用可以在应用层创建错误信息，以告知对端及/或其更高层，后者最终有能力终止QUIC连接。

将应用数据映射至流的方式视应用的不同而不同，《[QUIC-HTTP](../RFC9114_Chinese_Simplified)》中描述了HTTP/3的映射。
在设计某应用对流的使用方式时，存在一些适用的通用准则：

* 单条流内的数据是有序的。
如果应用要求按顺序接收特定数据，那么就应该在同一条流上发送这些数据。
在不同的流间，不保证传输、接收和交付顺序。

* 多条流间的数据是并发的。
可以被独立处理，且在强制接收顺序的情况下会引发队头阻塞的数据应该经由多条单独的流来传输。

* 流支持消息定向，且允许取消消息。
如果某条消息被映射至某条流上，那么重置该流就能使得某未得到确认的消息超时，利用这一点可以模拟该消息的部分可靠性。

如果QUIC的接收方打开的并发流数量达到了上限，发送方又表示需要更多的流，那么这不会导致接收方提高流的数量上限。
因此，应用应该在决定如何将数据映射至流上时将允许的流数量上限、当前打开的流数量和当前使用的流数量纳入考量。

QUIC向每条流分配一个数字标识符，称之为流ID。
尽管QUIC版本1中清晰地定义了这些标识符与流类型间的关系。
但是将来的版本可能出于各种理由更改此关系。
QUIC实现应该将各条流的属性暴露出来（哪个终端发起了流、流是单向的还是双向的、流的ID等）；应用应该查询这些属性，而不是尝试从流ID中推断它们。

向应用打开的流分配流标识符的方法可能因传输协议的实现不同而不同。
因此，应用不应该假设某个特定的流ID会被分配给某条尚未得到分配的流。
例如，HTTP/3使用流ID来引用已打开的流，但对于将来的流ID或其分配方式不做任何假设（详见《[QUIC-HTTP](../RFC9114_Chinese_Simplified)》的[第6章](../RFC9114_Chinese_Simplified/#6_Stream_Mapping_and_Usage)）。
